{% assign preview_image = product.featured_media %}
{% if preview_image %}
  {% assign preview_image = preview_image.preview_image %}
{% endif %}
{% if preview_image == blank %}
  {% assign preview_image = product.featured_image %}
{% endif %}

{% assign overrides = override_blocks %}
{% assign media_scale = section.settings.media_zoom | times: 0.01 | plus: 1 %}
{% if product_block and product_block.settings.media_zoom_override_enable == true %}
  {% assign media_scale = product_block.settings.media_zoom_override | times: 0.01 | plus: 1 %}
{% endif %}
{% assign first_variant = product.selected_or_first_available_variant %}
{% assign quick_shop_label = section.settings.quick_shop_button_label %}
{% if product_block and product_block.settings.order_button_label != blank %}
  {% assign quick_shop_label = product_block.settings.order_button_label %}
{% elsif quick_shop_label == blank and section.settings.order_button_label != blank %}
  {% assign quick_shop_label = section.settings.order_button_label %}
{% endif %}
{% if quick_shop_label == blank %}
  {% assign quick_shop_label = product.title %}
{% endif %}
{% assign quick_shop_add_label = section.settings.quick_shop_add_label | default: 'Add to cart' %}
{% assign quick_shop_checkout_label = section.settings.quick_shop_checkout_label | default: 'Checkout now' %}
{% assign quick_shop_modal_id = 'quick-modal-' | append: section.id | append: '-' | append: product.id %}

<li class="fc-carousel__slide" data-index="{{ index }}"{% if product_block %} {{ product_block.shopify_attributes }}{% endif %} style="--fc-media-scale: {{ media_scale }}">
  <article class="fc-card">
    <div class="fc-card__inner">
      <div class="fc-card__media">
        {% if preview_image %}
          <img src="{{ preview_image | image_url: width: 1600 }}" alt="{{ preview_image.alt | default: product.title | escape }}">
        {% else %}
          <div class="fc-card__placeholder">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
      </div>
      <div class="fc-card__content">
        <div class="fc-card__header">
          <h3 class="fc-card__title">{{ product.title }}</h3>
          {% if section.settings.show_price and product.price %}
            <p class="fc-card__price">{{ product.price | money_with_currency }}</p>
          {% endif %}
        </div>

        {% capture specs_markup %}
          {% for spec_index in (1..4) %}
            {% assign spec_index_str = spec_index | append: '' %}
            {% assign metric_key = 'spec_' | append: spec_index | append: '_metric' %}
            {% assign hint_key = 'spec_' | append: spec_index | append: '_hint' %}
            {% assign spec_override = overrides | where: 'settings.position', spec_index_str | first %}

            {% assign metric = '' %}
            {% assign hint = '' %}

            {% if spec_override %}
              {% assign metric = spec_override.settings.metric %}
              {% assign hint = spec_override.settings.hint %}
            {% elsif product_block %}
              {% assign metric = product_block.settings[metric_key] %}
              {% assign hint = product_block.settings[hint_key] %}
            {% else %}
              {% assign metric = section.settings[metric_key] %}
              {% assign hint = section.settings[hint_key] %}
            {% endif %}

            {% if metric != blank or hint != blank %}
              <div class="fc-card__spec">
                {% if metric != blank %}
                  <span class="fc-card__spec-title">{{ metric }}</span>
                {% endif %}
                {% if hint != blank %}
                  <span class="fc-card__spec-subtitle">{{ hint }}</span>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        {% endcapture %}

        {% assign specs_markup_trimmed = specs_markup | strip %}
        {% if specs_markup_trimmed != '' %}
          <div class="fc-card__specs">
            {{ specs_markup_trimmed }}
          </div>
        {% endif %}

{% assign learn_label = section.settings.learn_button_label | default: 'Learn More' %}
{% assign learn_link = section.settings.default_learn_link %}

{% if product_block %}
  {% if product_block.settings.learn_button_label != blank %}
    {% assign learn_label = product_block.settings.learn_button_label %}
  {% endif %}
  {% if product_block.settings.learn_button_link != blank %}
    {% assign learn_link = product_block.settings.learn_button_link %}
  {% elsif product_block.settings.learn_more_link != blank %}
    {% assign learn_link = product_block.settings.learn_more_link %}
  {% endif %}
{% endif %}

{% if learn_link == blank %}
  {% assign learn_link = product.url %}
{% endif %}

<div class="fc-card__buttons">
  <button
    type="button"
    class="fc-button fc-button--primary fc-button--quick"
    data-quick-shop-open="{{ quick_shop_modal_id }}"
  >
    {{ quick_shop_label }}
  </button>
  <a class="fc-button fc-button--secondary" href="{{ learn_link }}">
    {{ learn_label }}
  </a>
</div>

{% assign quick_shop_default_variant = first_variant %}
{% if quick_shop_default_variant == nil %}
  {% assign quick_shop_default_variant = product.variants.first %}
{% endif %}
          {% assign quick_shop_default_price = quick_shop_default_variant.price | default: product.price %}
          {% assign quick_shop_default_price_formatted = quick_shop_default_price | money %}
          {% assign quick_shop_default_available = quick_shop_default_variant.available | default: false %}
          {% assign quick_shop_default_min = quick_shop_default_variant.quantity_rule.min | default: 1 %}
          {% assign quick_shop_default_image = nil %}
          {% assign quick_shop_default_image_alt = product.title %}
          {% if quick_shop_default_variant and quick_shop_default_variant.image %}
            {% assign quick_shop_default_image = quick_shop_default_variant.image %}
            {% assign quick_shop_default_image_alt = quick_shop_default_variant.image.alt | default: quick_shop_default_variant.title %}
          {% elsif product.featured_image %}
            {% assign quick_shop_default_image = product.featured_image %}
            {% assign quick_shop_default_image_alt = product.featured_image.alt | default: product.title %}
          {% endif %}
          <div
            id="{{ quick_shop_modal_id }}"
            class="quick-shop-modal"
            data-quick-shop-modal
            data-section-id="{{ section.id }}"
            hidden
            data-default-variant-id="{% if quick_shop_default_variant %}{{ quick_shop_default_variant.id }}{% endif %}"
          >
            <div class="quick-shop-modal__backdrop" data-quick-shop-close></div>
            <div class="quick-shop-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="{{ quick_shop_modal_id }}-title" tabindex="-1">
              <button class="quick-shop-modal__close" type="button" data-quick-shop-close aria-label="Close quick shop">
                <span aria-hidden="true">&times;</span>
              </button>
              <div class="quick-shop-modal__content">
                <div class="quick-shop-modal__media">
                  {% if quick_shop_default_image %}
                    <img src="{{ quick_shop_default_image | image_url: width: 900 }}" alt="{{ quick_shop_default_image_alt | escape }}" data-quick-shop-hero>
                  {% else %}
                    <div class="quick-shop-modal__media-placeholder" aria-hidden="true"></div>
                  {% endif %}
                </div>
                <div class="quick-shop-modal__info">
                  <h2 class="quick-shop-modal__title" id="{{ quick_shop_modal_id }}-title">{{ product.title }}</h2>
                  <div
                    class="quick-shop-modal__price"
                    data-quick-shop-price
                    data-price="{{ quick_shop_default_price }}"
                    data-price-formatted="{{ quick_shop_default_price_formatted }}"
                  >
                    {{ quick_shop_default_price_formatted }}
                  </div>

                  {% if product.variants.size > 1 %}
                    <div class="quick-shop-modal__field">
                      <label class="quick-shop-modal__label" for="{{ quick_shop_modal_id }}-variant">Select variant</label>
                      <select class="quick-shop-modal__select" id="{{ quick_shop_modal_id }}-variant" data-quick-shop-variant>
                        {% for modal_variant in product.variants %}
                          {% assign variant_image_src = '' %}
                          {% assign variant_image_alt = product.title %}
                          {% if modal_variant.image %}
                            {% assign variant_image_src = modal_variant.image | image_url: width: 900 %}
                            {% assign variant_image_alt = modal_variant.image.alt | default: modal_variant.title %}
                          {% endif %}
                          <option
                            value="{{ modal_variant.id }}"
                            data-price="{{ modal_variant.price }}"
                            data-price-formatted="{{ modal_variant.price | money }}"
                            data-available="{{ modal_variant.available }}"
                            data-image="{{ variant_image_src }}"
                            data-image-alt="{{ variant_image_alt | escape }}"
                            data-min="{{ modal_variant.quantity_rule.min | default: 1 }}"
                            {% if quick_shop_default_variant and modal_variant.id == quick_shop_default_variant.id %}selected{% endif %}
                          >
                            {{ modal_variant.title }}{% unless modal_variant.available %} - Sold out{% endunless %}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% else %}
                    {% assign single_variant = product.variants.first %}
                    <input
                      type="hidden"
                      data-quick-shop-variant
                      value="{{ single_variant.id }}"
                      data-price="{{ single_variant.price }}"
                      data-price-formatted="{{ single_variant.price | money }}"
                      data-available="{{ single_variant.available }}"
                      data-image="{% if single_variant.image %}{{ single_variant.image | image_url: width: 900 }}{% endif %}"
                      data-image-alt="{% if single_variant.image %}{{ single_variant.image.alt | default: single_variant.title | escape }}{% else %}{{ product.title | escape }}{% endif %}"
                      data-min="{{ single_variant.quantity_rule.min | default: 1 }}"
                    >
                  {% endif %}

                  <div class="quick-shop-modal__field quick-shop-modal__field--quantity">
                    <span class="quick-shop-modal__label">Quantity</span>
                    <div class="quick-shop-modal__quantity">
                      <button type="button" data-quick-qty-decrease aria-label="Decrease quantity">&minus;</button>
                      <input
                        type="number"
                        data-quick-shop-quantity
                        min="{{ quick_shop_default_min }}"
                        value="{{ quick_shop_default_min }}"
                      >
                      <button type="button" data-quick-qty-increase aria-label="Increase quantity">&#43;</button>
                    </div>
                  </div>

                  <div class="quick-shop-modal__actions">
                    <button class="quick-shop-modal__btn quick-shop-modal__btn--primary" type="button" data-quick-shop-add {% unless quick_shop_default_available %}disabled{% endunless %}>
                      {{ quick_shop_add_label }}
                    </button>
                    <button class="quick-shop-modal__btn quick-shop-modal__btn--secondary" type="button" data-quick-shop-checkout {% unless quick_shop_default_available %}disabled{% endunless %}>
                      {{ quick_shop_checkout_label }}
                    </button>
                  </div>
                  <p class="quick-shop-modal__feedback" data-quick-shop-feedback role="status" aria-live="polite"></p>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
  </article>
</li>
